## 后端系统设计方案

### 1. 技术栈选择
- **后端框架**: Node.js + Express
- **数据库**: MongoDB (使用Mongoose ORM)
- **认证方式**: JWT (JSON Web Token)
- **API风格**: RESTful

### 2. 项目结构
```
backend/
├── config/                  # 配置文件
│   ├── db.js               # 数据库连接配置
│   └── jwt.js              # JWT密钥配置
├── controllers/            # 控制器
│   ├── authController.js   # 认证相关
│   └── orderController.js  # 订单管理
├── middleware/             # 中间件
│   └── authMiddleware.js   # JWT认证中间件
├── models/                 # 数据模型
│   ├── User.js             # 用户模型
│   └── Order.js            # 订单模型
├── routes/                 # 路由
│   ├── authRoutes.js       # 认证路由
│   └── orderRoutes.js      # 订单路由
├── .env                    # 环境变量
├── package.json            # 项目依赖
└── server.js               # 服务器入口
```

### 3. 核心数据模型

#### 用户模型 (User.js)
```javascript
const mongoose = require('mongoose');

const UserSchema = new mongoose.Schema({
  username: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  role: { type: String, enum: ['admin', 'user'], default: 'user' },
  createdAt: { type: Date, default: Date.now }
});

module.exports = mongoose.model('User', UserSchema);
```

#### 订单模型 (Order.js)
```javascript
const mongoose = require('mongoose');

const OrderSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
  userName: { type: String, required: true },
  goods: [{ 
    id: { type: Number, required: true },
    name: { type: String, required: true },
    price: { type: Number, required: true },
    count: { type: Number, required: true }
  }],
  totalPrice: { type: Number, required: true },
  createTime: { type: Date, default: Date.now },
  status: { type: String, enum: ['pending', 'completed'], default: 'pending' }
});

module.exports = mongoose.model('Order', OrderSchema);
```

### 4. API 端点设计

#### 认证相关
- `POST /api/auth/login` - 管理员登录
- `GET /api/auth/me` - 获取当前登录用户信息

#### 订单相关
- `POST /api/orders` - 提交新订单 (用户)
- `GET /api/orders` - 获取所有订单 (管理员)
- `GET /api/orders/:id` - 获取单个订单详情 (管理员)
- `PUT /api/orders/:id/status` - 更新订单状态 (管理员)

### 5. 前端集成方案

#### 5.1 全局配置修改
在 `app.js` 中添加后端API基础URL：
```javascript
globalData: {
  // ...
  apiBaseUrl: 'http://localhost:3000/api',
  // ...
}
```

#### 5.2 订单提交逻辑修改
修改 `pages/goods/index.js` 中的 `submitOrder` 函数：
```javascript
// 提交订单
submitOrder() {
  // ... 现有验证逻辑
  
  // 准备订单数据
  const orderData = {
    userName: wx.getStorageSync('username'),
    goods: selectedGoods,
    totalPrice: this.data.totalPrice
  };
  
  // 发送请求到后端
  wx.request({
    url: getApp().globalData.apiBaseUrl + '/orders',
    method: 'POST',
    data: orderData,
    success: (res) => {
      if (res.statusCode === 201) {
        // 订单提交成功
        wx.showToast({
          title: "订单提交成功",
          icon: "success",
          duration: 1500,
          success: () => {
            // 重置商品数量和总价
            // ... 现有重置逻辑
          }
        });
      }
    },
    fail: (err) => {
      wx.showToast({
        title: "订单提交失败",
        icon: "none"
      });
    }
  });
}
```

#### 5.3 管理员订单列表修改
修改 `pages/orders/index.js` 中的 `loadOrders` 函数：
```javascript
// 加载订单数据
loadOrders() {
  wx.request({
    url: getApp().globalData.apiBaseUrl + '/orders',
    method: 'GET',
    header: {
      'Authorization': 'Bearer ' + wx.getStorageSync('token')
    },
    success: (res) => {
      if (res.statusCode === 200) {
        this.setData({
          orders: res.data,
        });
      }
    }
  });
}
```

#### 5.4 管理员登录逻辑修改
修改 `pages/login/index.js` 中的 `login` 函数，增加管理员JWT获取：
```javascript
// 登录
login() {
  // ... 现有验证逻辑
  
  // 发送登录请求到后端
  wx.request({
    url: getApp().globalData.apiBaseUrl + '/auth/login',
    method: 'POST',
    data: { username, password },
    success: (res) => {
      if (res.statusCode === 200) {
        // 登录成功，保存登录状态和token
        wx.setStorageSync('isLoggedIn', true);
        wx.setStorageSync('userType', res.data.role);
        wx.setStorageSync('username', res.data.username);
        wx.setStorageSync('token', res.data.token);
        
        // 跳转到对应页面
        // ... 现有跳转逻辑
      } else {
        this.setData({
          errorMsg: '用户名或密码错误'
        });
      }
    }
  });
}
```

### 6. 后端实现要点

#### 6.1 服务器启动与配置
```javascript
// server.js
const express = require('express');
const cors = require('cors');
const mongoose = require('mongoose');
const authRoutes = require('./routes/authRoutes');
const orderRoutes = require('./routes/orderRoutes');
const { dbURI } = require('./config/db');

const app = express();

// 中间件
app.use(cors());
app.use(express.json());

// 路由
app.use('/api/auth', authRoutes);
app.use('/api/orders', orderRoutes);

// 数据库连接
mongoose.connect(dbURI, {
  useNewUrlParser: true,
  useUnifiedTopology: true
}).then(() => {
  console.log('MongoDB connected');
  app.listen(3000, () => {
    console.log('Server running on port 3000');
  });
}).catch(err => {
  console.error('Database connection error:', err);
});
```

#### 6.2 JWT认证中间件
```javascript
// middleware/authMiddleware.js
const jwt = require('jsonwebtoken');
const { jwtSecret } = require('../config/jwt');

module.exports = (req, res, next) => {
  const token = req.header('Authorization')?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({ message: 'No token, authorization denied' });
  }
  
  try {
    const decoded = jwt.verify(token, jwtSecret);
    req.user = decoded;
    next();
  } catch (err) {
    res.status(401).json({ message: 'Token is not valid' });
  }
};
```

### 7. 部署与运行

1. **后端部署**：
   - 安装依赖：`npm install`
   - 配置环境变量：创建 `.env` 文件，设置数据库连接字符串和JWT密钥
   - 启动服务器：`npm start`

2. **前端配置**：
   - 在 `app.js` 中修改 `apiBaseUrl` 为实际后端地址
   - 确保微信开发者工具允许访问HTTP接口（开发环境）

### 8. 安全考虑

- 使用HTTPS协议（生产环境）
- 密码加密存储（使用bcrypt）
- JWT令牌设置合理的过期时间
- API请求添加适当的验证和错误处理
- 管理员路由添加权限控制

### 9. 数据流程

1. 用户在小程序中选择菜品，点击提交订单
2. 前端收集订单数据，调用后端 `/api/orders` 接口
3. 后端验证数据，保存到MongoDB数据库
4. 管理员登录后，前端调用 `/api/orders` 获取所有订单
5. 后端验证管理员身份，返回所有订单数据
6. 管理员在小程序中查看订单列表和详情

这个方案实现了前后端分离，后端负责数据存储和业务逻辑，前端负责用户交互，管理员可以实时查看所有用户提交的订单。